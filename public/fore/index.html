<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>调试界面</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1, user-scalable=no">
    <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script src="../static/script/jquery-3.2.1.min.js"></script>
    <style>
        body {
            margin: 0 auto;
        }

        #pay {
            background-color: #1AAD19;
            position: relative;
            display: block;
            margin-left: auto;
            margin-right: auto;
            padding-left: 14px;
            padding-right: 14px;
            box-sizing: border-box;
            font-size: 18px;
            text-align: center;
            text-decoration: none;
            color: #FFFFFF;
            line-height: 2.55555556;
            border-radius: 5px;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            overflow: hidden;
        }

    </style>
</head>
<body>
<button id="pay" ONCLICK="getPayConfig()">微信支付</button>
</body>
</html>
<script type="text/javascript">
    $(document).ready(function () {
        // wxLogin()
        init()
    });
    // function getUrlParam(name) {
    //     var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    //     var r = window.location.search.substr(1).match(reg);
    //     if (r != null) return unescape(r[2]);
    //     return null;
    // }
    //
    // function wxLogin(callback) {
    //     var appId = 'wx33584f71b4a84fa9';
    //     var oauth_url = 'http://tpbook.codwiki.cn/weixin/oauth';
    //     var url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=" + appId + "&redirect_uri=" + location.href.split('#')[0] + "&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect"
    //     var code = getUrlParam("code");
    //     if (!code) {
    //         window.location = url;
    //     } else {
    //         $.ajax({
    //             type: 'GET',
    //             url: oauth_url,
    //             dataType: 'json',
    //             data: {
    //                 code: code
    //             },
    //             success: function (data) {
    //                 if (data.code === 200) {
    //                     callback(data.data)
    //                 }
    //             },
    //             error: function (error) {
    //                 throw new Error(error)
    //             }
    //         })
    //     }
    // }

    //
    // var wxlogin = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx33584f71b4a84fa9&redirect_uri='
    //     + window.location.href + '&response_type=code&scope=snsapi_userinfo&state=1#wechat_redirect';
    // if (!getUrlParam('code')) {
    //     window.location = wxlogin;
    // }
    // console.log(getUrlParam('code'));
    // $.ajax({
    //     //请求方式
    //     type: 'POST',
    //     //发送请求的地址
    //     url: 'http://tpbook.codwiki.cn/weixin/wxconfig',
    //     //服务器返回的数据类型
    //     dataType: 'json',
    //     //发送到服务器的数据，对象必须为key/value的格式，jquery会自动转换为字符串格式
    //     data: {
    //         jsApiList: "openLocation",
    //         debug: 1,
    //         url: location.href.split('#')[0]
    //     },
    //     success: function (data) {
    //         //请求成功函数内容
    //         wx.config(data.data);
    //         wx.ready(function () {
    //             wx.openLocation({
    //                 latitude: 23.099994,
    //                 longitude: 113.324520,
    //                 name: 'TIT 鍒涙剰鍥�',
    //                 address: '骞垮窞甯傛捣鐝犲尯鏂版腐涓矾 397 鍙�',
    //                 scale: 14,
    //                 infoUrl: 'http://weixin.qq.com'
    //             });
    //         });
    //
    //     },
    //     error: function (error) {
    //         //请求失败函数内容
    //         console.log(error)
    //     }
    // });
    // 微信网页授权
    // wx33584f71b4a84fa9

    function init() {
        $.ajax({
            type: 'POST',
            url: 'http://tpbook.codwiki.cn/weixin/wxconfig',
            dataType: 'json',
            data: {
                jsApiList: "openLocation,chooseWXPay",
                debug: 1,
                url: location.href.split('#')[0]
            },
            success: function (data) {
                wx.config(data.data);
            },
            error: function (error) {
                console.log(error)
            }
        });
    }

    function getPayConfig() {
        $.ajax({
            type: 'GET',
            url: 'http://tpbook.codwiki.cn/wxpay/payConfig',
            dataType: 'json',
            success: function (data) {
                var config = data.data;
                wx.ready(function () {
                    wx.chooseWXPay({
                        timestamp: config['timestamp'],
                        nonceStr: config['nonceStr'],
                        package: config['package'],
                        signType: config['signType'],
                        paySign: config['paySign'], // 支付签名
                        success: function (res) {
                            $("body").append(res)
                        }, error: function (error) {
                            $("body").append(error)
                        }
                    })
                });

            },
            error: function (error) {
                $("body").append(error.toString())
            }
        });
    }

    // 微信支付
</script>